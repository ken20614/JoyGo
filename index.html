<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joyçš„ç§˜å¯†</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script></script>
    <style>
        .node-container {
            transition: all 0.3s ease;
        }
        .risk-low {
            background-color: #c8d5bb;
            border-color: #a4b899;
            color: #4a5845;
        }
        .risk-medium {
            background-color: #e4d4c8;
            border-color: #c9b5a8;
            color: #6b5a4f;
        }
        .risk-high {
            background-color: #d9b8b8;
            border-color: #c49a9a;
            color: #6b4a4a;
        }
        .risk-none {
            background-color: #cbd5dd;
            border-color: #a8b5c2;
            color: #495661;
        }
        .tree-line {
            border-left: 2px solid #d1d5db;
            margin-left: 20px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-stone-50 via-rose-50 to-blue-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
                <h1 class="text-3xl font-bold text-gray-800">Joyçš„ç§˜å¯†</h1>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="shareLink()" class="px-4 py-2 bg-purple-300 text-white rounded hover:bg-purple-400 transition">
                        ğŸ”— åˆ†äº«é€£çµ
                    </button>
                    <button onclick="resetData()" class="px-4 py-2 bg-rose-300 text-white rounded hover:bg-rose-400 transition">
                        ğŸ”„ é‡ç½®
                    </button>
                </div>
            </div>

            <div class="mb-4 p-4 bg-amber-50/80 rounded-lg border border-amber-200/50">
                <div class="text-sm text-stone-600">
                    <div class="font-semibold mb-2">ä½¿ç”¨èªªæ˜ï¼š</div>
                    <ul class="list-disc list-inside space-y-1">
                        <li>é»æ“Š âœï¸ ç·¨è¼¯é¸é …å…§å®¹</li>
                        <li>é»æ“Š â• æ–°å¢å­é¸é …</li>
                        <li>é»æ“Š ğŸ—‘ï¸ åˆªé™¤é¸é …</li>
                        <li>é»æ“Šç®­é ­å±•é–‹/æ”¶åˆå­é¸é …</li>
                        <li>ğŸ”— åˆ†äº«é€£çµï¼šç”¢ç”Ÿå£“ç¸®å¾Œçš„åˆ†äº«ç¶²å€ï¼ˆå£“ç¸®ç‡ç´„ 60-70%ï¼‰</li>
                        <li>ğŸ’¡ å»ºè­°ç”¨ bit.ly æˆ– reurl.cc å†æ¬¡ç¸®çŸ­ç¶²å€</li>
                    </ul>
                </div>
            </div>

            <div id="treeContainer" class="overflow-x-auto"></div>
        </div>
    </div>

    <script>
        const initialData = {
            id: 'root',
            text: 'æˆ¿å­',
            expanded: true,
            children: [
                {
                    id: 'sell',
                    text: 'è³£',
                    risk: 'low',
                    expanded: true,
                    children: [
                        {
                            id: 'sell-1',
                            text: 'å„Ÿé‚„è²¸æ¬¾å¾Œé¤˜é¡å‡åˆ†å…©æ¸…',
                            note: 'é¢¨éšªæœ€ä½ã€æœ€ä¹¾è„†',
                            risk: 'low'
                        }
                    ]
                },
                {
                    id: 'not-sell',
                    text: 'ä¸è³£',
                    expanded: true,
                    children: [
                        {
                            id: 'litigation',
                            text: 'è¨´è¨Ÿè·¯ç·š',
                            note: 'é›™è¼¸æ¨¡å¼',
                            risk: 'high',
                            expanded: true,
                            children: [
                                {
                                    id: 'lit-1',
                                    text: 'å‰©é¤˜è²¡ç”¢åˆ†é…è«‹æ±‚æ¬Š',
                                    note: 'æœƒç‰½å‹•åä¸‹å…¶ä»–è²¡ç”¢',
                                    risk: 'high'
                                },
                                {
                                    id: 'lit-2',
                                    text: 'åˆ†å‰²å…±æœ‰ç‰©',
                                    note: 'é›¢å©šå¤–çš„å¦ä¸€å€‹å®˜å¸',
                                    risk: 'high'
                                },
                                {
                                    id: 'lit-3',
                                    text: 'æ³•æ‹',
                                    note: 'æœ€å¾Œæ‰‹æ®µ æœƒå½±éŸ¿æˆ‘ä¿¡ç”¨',
                                    risk: 'high'
                                }
                            ]
                        },
                        {
                            id: 'non-litigation',
                            text: 'éè¨´è¨Ÿè·¯ç·š',
                            risk: 'medium',
                            expanded: true,
                            children: [
                                {
                                    id: 'agree-1',
                                    text: 'å”è­° + åŒä½',
                                    note: 'å¿ƒç†å£“åŠ›å¤§ï¼Œä½†æ³•å¾‹æœ€å®‰å…¨ ç§ŸèœœåŸºåœ°',
                                    risk: 'medium'
                                },
                                {
                                    id: 'agree-2',
                                    text: 'å”è­° + ä»–æ¬å‡ºå»',
                                    note: 'èƒ½æ¥å—çš„ç‰ˆæœ¬',
                                    risk: 'low'
                                },
                                {
                                    id: 'agree-3',
                                    text: 'å”è­° + æˆ‘æ¬å‡ºå»',
                                    note: 'æœ€ä¸åˆ©è·¯ç·š',
                                    risk: 'high'
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        let treeData = null;
        let editingId = null;

        function loadData() {
            const saved = localStorage.getItem('decisionTree');
            treeData = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(initialData));
        }

        function saveData() {
            localStorage.setItem('decisionTree', JSON.stringify(treeData));
        }

        function resetData() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚')) {
                treeData = JSON.parse(JSON.stringify(initialData));
                saveData();
                render();
                alert('âœ… å·²é‡ç½®ç‚ºåˆå§‹è³‡æ–™ï¼');
            }
        }

        // å£“ç¸®è³‡æ–™
        function compressData(data) {
            const jsonStr = JSON.stringify(data);
            const compressed = pako.deflate(jsonStr, { level: 9 });
            const base64 = btoa(String.fromCharCode.apply(null, compressed));
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        // è§£å£“ç¸®è³‡æ–™
        function decompressData(base64) {
            try {
                const normalized = base64.replace(/-/g, '+').replace(/_/g, '/');
                const padding = '='.repeat((4 - normalized.length % 4) % 4);
                const binary = atob(normalized + padding);
                const bytes = new Uint8Array(binary.length);
                for (let i = 0; i < binary.length; i++) {
                    bytes[i] = binary.charCodeAt(i);
                }
                const decompressed = pako.inflate(bytes, { to: 'string' });
                return JSON.parse(decompressed);
            } catch (error) {
                console.error('è§£å£“ç¸®å¤±æ•—:', error);
                return null;
            }
        }

        function shareLink() {
            const compressed = compressData(treeData);
            const baseUrl = window.location.origin + window.location.pathname;
            const shareUrl = `${baseUrl}?d=${compressed}`;
            
            // è¨ˆç®—å£“ç¸®ç‡
            const original = encodeURIComponent(JSON.stringify(treeData)).length;
            const compressed_len = compressed.length;
            const ratio = Math.round((1 - compressed_len / original) * 100);
            
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert(`ğŸ”— åˆ†äº«é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\nå£“ç¸®ç‡ï¼š${ratio}%\né€£çµé•·åº¦ï¼š${shareUrl.length} å­—å…ƒ\n\nåˆ¥äººæ‰“é–‹é€™å€‹é€£çµå°±èƒ½çœ‹åˆ°ä½ çš„æ±ºç­–æ¨¹ã€‚\n\nğŸ’¡ å»ºè­°ï¼šç”¨ bit.ly æˆ– reurl.cc ç¸®çŸ­ç¶²å€æ›´æ–¹ä¾¿åˆ†äº«ï¼`);
            }).catch(() => {
                prompt('è«‹è¤‡è£½ä»¥ä¸‹é€£çµåˆ†äº«ï¼š', shareUrl);
            });
        }

        function loadFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('d');
            
            if (dataParam) {
                const decoded = decompressData(dataParam);
                if (decoded) {
                    treeData = decoded;
                    saveData();
                    window.history.replaceState({}, document.title, window.location.pathname);
                    alert('âœ… å·²è¼‰å…¥åˆ†äº«çš„æ±ºç­–æ¨¹ï¼');
                } else {
                    alert('âŒ è¼‰å…¥å¤±æ•—ï¼Œé€£çµå¯èƒ½å·²æå£ã€‚');
                }
            }
        }

        function getRiskClass(risk) {
            return risk ? `risk-${risk}` : 'risk-none';
        }

        function getRiskBadge(risk) {
            switch(risk) {
                case 'low': return 'âœ“ ä½é¢¨éšª';
                case 'medium': return '! ä¸­é¢¨éšª';
                case 'high': return 'âœ— é«˜é¢¨éšª';
                default: return '';
            }
        }

        function findNode(nodes, id) {
            for (let node of nodes) {
                if (node.id === id) return node;
                if (node.children) {
                    const found = findNode(node.children, id);
                    if (found) return found;
                }
            }
            return null;
        }

        function updateNode(id, updates) {
            const node = findNode([treeData], id);
            if (node) {
                Object.assign(node, updates);
                saveData();
                render();
            }
        }

        function deleteNode(nodes, id) {
            return nodes.filter(node => {
                if (node.id === id) return false;
                if (node.children) {
                    node.children = deleteNode(node.children, id);
                }
                return true;
            });
        }

        function addChild(id) {
            const parent = findNode([treeData], id);
            if (parent) {
                if (!parent.children) parent.children = [];
                parent.children.push({
                    id: `node-${Date.now()}`,
                    text: 'æ–°é¸é …',
                    note: '',
                    risk: '',
                    children: []
                });
                parent.expanded = true;
                saveData();
                render();
            }
        }

        function toggleExpand(id) {
            const node = findNode([treeData], id);
            if (node) {
                node.expanded = !node.expanded;
                saveData();
                render();
            }
        }

        function startEdit(id) {
            editingId = id;
            render();
        }

        function saveEdit(id) {
            const text = document.getElementById('edit-text').value;
            const note = document.getElementById('edit-note').value;
            const risk = document.getElementById('edit-risk').value;
            
            updateNode(id, { text, note, risk });
            editingId = null;
        }

        function cancelEdit() {
            editingId = null;
            render();
        }

        function deleteNodeById(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é¸é …å—ï¼Ÿ')) {
                treeData.children = deleteNode([treeData], id);
                saveData();
                render();
            }
        }

        function renderNode(node, level = 0) {
            const hasChildren = node.children && node.children.length > 0;
            const isExpanded = node.expanded !== false;
            const isEditing = editingId === node.id;

            let html = '<div class="flex items-start my-2">';
            
            // ç¯€é»æœ¬èº«
            html += '<div class="flex-shrink-0">';
            html += `<div class="p-3 rounded-lg border-2 ${getRiskClass(node.risk)} min-w-[200px] max-w-[300px]">`;
            
            // å±•é–‹æŒ‰éˆ•ï¼ˆå¦‚æœæœ‰å­ç¯€é»ï¼‰
            if (hasChildren) {
                html += `<button onclick="toggleExpand('${node.id}')" class="float-right hover:bg-white/50 rounded p-1 ml-2">
                    ${isExpanded ? 'â—€' : 'â–¶'}
                </button>`;
            }

            if (isEditing) {
                const currentNode = findNode([treeData], node.id);
                html += `
                    <div class="space-y-2">
                        <input type="text" id="edit-text" value="${currentNode.text}" 
                            class="w-full px-2 py-1 border rounded" placeholder="é¸é …åç¨±">
                        <input type="text" id="edit-note" value="${currentNode.note || ''}" 
                            class="w-full px-2 py-1 border rounded text-sm" placeholder="å‚™è¨»èªªæ˜">
                        <select id="edit-risk" class="px-2 py-1 border rounded text-sm w-full">
                            <option value="" ${!currentNode.risk ? 'selected' : ''}>ç„¡é¢¨éšªæ¨™è¨˜</option>
                            <option value="low" ${currentNode.risk === 'low' ? 'selected' : ''}>ä½é¢¨éšª</option>
                            <option value="medium" ${currentNode.risk === 'medium' ? 'selected' : ''}>ä¸­é¢¨éšª</option>
                            <option value="high" ${currentNode.risk === 'high' ? 'selected' : ''}>é«˜é¢¨éšª</option>
                        </select>
                        <div class="flex gap-2">
                            <button onclick="saveEdit('${node.id}')" 
                                class="px-2 py-1 bg-teal-300 text-white rounded hover:bg-teal-400 text-sm flex-1">
                                ğŸ’¾
                            </button>
                            <button onclick="cancelEdit()" 
                                class="px-2 py-1 bg-stone-200 rounded hover:bg-stone-300 text-sm flex-1">
                                âœ•
                            </button>
                        </div>
                    </div>
                `;
            } else {
                html += `<div class="font-semibold text-base mb-1">${node.text}</div>`;
                if (node.note) {
                    html += `<div class="text-xs mt-1 opacity-75">${node.note}</div>`;
                }
                if (node.risk) {
                    html += `<div class="text-xs mt-2 font-medium">${getRiskBadge(node.risk)}</div>`;
                }
                
                if (node.id !== 'root') {
                    html += `
                        <div class="flex gap-1 mt-2">
                            <button onclick="startEdit('${node.id}')" 
                                class="p-1 hover:bg-white/50 rounded text-sm" title="ç·¨è¼¯">âœï¸</button>
                            <button onclick="addChild('${node.id}')" 
                                class="p-1 hover:bg-white/50 rounded text-sm" title="æ–°å¢å­é¸é …">â•</button>
                            <button onclick="deleteNodeById('${node.id}')" 
                                class="p-1 hover:bg-white/50 rounded text-red-600 text-sm" title="åˆªé™¤">ğŸ—‘ï¸</button>
                        </div>
                    `;
                }
            }

            html += '</div></div>';

            // å­ç¯€é»ï¼ˆæ©«å‘æ’åˆ—ï¼‰
            if (hasChildren && isExpanded) {
                html += '<div class="flex flex-col gap-2 ml-6 pl-6 border-l-2 border-gray-300">';
                node.children.forEach(child => {
                    html += renderNode(child, level + 1);
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        function render() {
            document.getElementById('treeContainer').innerHTML = renderNode(treeData);
        }

        loadData();
        loadFromUrl();
        render();
    </script>
</body>
</html>
